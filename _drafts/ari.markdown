---
layout: post
title:  "Adjusted Rand Index (ARI) について勉強してみた"
date: 2016-05-24 19:46:44 +0900
categories: jekyll update
---
クラスタリングの性能評価でよくAdjusted Rand Index (ARI) が使われます．
僕もよく使っていますが，お恥ずかしながらよく知らずに使っていました．
というのも，Rand Index (RI) は理解できるのですが，ARIのAdjustedの意味がよくわかりませんでした．
というわけで，勉強してみました．

まず，クラスタリングは，サンプル$$S = \{o_i\}_{i=1}^n$$を$$k (1 \leq k \leq n)$$個の互いに素なグループに分けることを目的とします．
この記事では，真のクラスタリング結果と，クラスタリングアルゴリズムの結果が似ているかどうかを測ることを目的とします．
なお，ここでは，クラスタリングの結果をクラスタラベルで表現することにします．

さて，$$S$$に対する，
真のクラスタラベルを$$ \boldsymbol{\ell}=[\ell_1 \cdots \ell_n], \ell_i \in \{1, \ldots, k\} \forall i=1, \ldots, n$$，
クラスタリングアルゴリズムによるクラスタラベルを$$\hat{ \boldsymbol{\ell}}=[\hat{\ell}_1 \cdots \hat{\ell}_n], \hat{\ell}_i \in \{1, \ldots, \hat{k}\} \forall i=1, \ldots, n$$とします．
クラスタリングの結果は，分類のようにラベルで考えるのではなく，ラベルのペアで考えます．
つまり，「このサンプルとこのサンプルは同じクラスタに属するか否か」で性能を評価します．

そのような指標の一つである，Rand Indexは次式で定義されます（自己流です）．

$$
\begin{align*}
RI(\boldsymbol{\ell}, \hat{\boldsymbol{\ell}}) = \frac{1}{|C(n, 2)|}\sum_{(i, j) \in C(n, 2)} I(I(\ell_i = \ell_j) = I(\hat{\ell}_i = \hat{\ell}_j))
\end{align*}
$$

ただし，
$$C(n, 2) = \{(i, j) | i, j \in \{1, \ldots, n\}, i<j \}$$
はサンプルの2つの全組み合わせ．

これはわかりやすいです．サンプルペアが同じクラスタに属するのか違うクラスタに属するのかが測れそうです．

よくRIの欠点として，「二つのクラスタリングに相関がなくても，高い値をとってしまう」という説明がなされます．
これの意味は，「適当（ランダム）にやっても高い値をとってしまう」ということではないかと思います．
さて，この「相関」ですが，普通「相関」というと確率変数間の相関をイメージしますよね．
ということでどの確率変数とどの確率変数の間の相関のことを言っているのかから考えていきます．

まず，以下の二つの標本を考えます：

$$
\begin{align*}
X &= \{I(\ell_i = \ell_j) | (i,j) \in C(n, 2)\} \\
Y &= \{I(\hat{\ell}_i = \hat{\ell}_j) | (i,j) \in C(n, 2)\}
\end{align*}
$$

そして，$$X, Y$$に対応する確率変数をそれぞれ$$x, y$$とし，$$X, Y$$はそれぞれ$$x, y$$の従う確率分布から独立に生成されたと仮定します (i.i.d.)．
上で言った「相関」とは，多分この$$x$$と$$y$$の相関のことだと思います．

さて，適当にやった時，つまり，$$x$$と$$y$$に相関がない ($$x \perp y$$) 時に，RIの値を下げたいのですが，どうしたら良いでしょうか？
もう少し具体的にいうと，RIの値は分子で決まるので，RIの分子の値を下げたいのですが，どうしたら良いでしょう？
直感的にいうと，「適当にクラスタリングしたら，RIの分子がどのくらいになるか」がわかれば，それをペナルティに設定すれば良さそうではないですか？
というわけで，ペナルティ = 適当にクラスタリングした時のRIの分子のおおよその値 = $$x \perp y$$の時のRIの分子のおおよその値を求めていきます．

とりあえず，見やすくするために，上の$$X, Y$$を，
$$X = \{x_i\}_{i=1}^{m}, Y = \{y_i\}_{i=1}^{m}, m={}_n C _2$$と置き直します．
さらに，$$Z = \{z_i\}_{i=1}^m, z_i = I(x_i = y_i)$$と置きます．
そうすると，RIは以下の式になります．

$$
\begin{align*}
RI(y, \hat{y}) = \frac{1}{m} \sum_{i=1}^m I(x_i = y_i)
\end{align*}
$$

上でざっくり定義したペナルティを求めるために，$$x$$と$$y$$が，それぞれベルヌーイ分布に従う，
つまり，$$x \sim Bernoulli(p_x), y \sim Bernoulli(p_y), x \perp y$$を仮定します．
さらに，$$Bernoulli(p_x), Bernoulli(p_y)$$の確率質量関数をそれぞれ$$p(x), p(y)$$とします．
ここで，RIの分子の和の中に出現する，以下で定義される確率変数$$z$$を考えます．

$$
\begin{align*}
z = I(x = y)
\end{align*}
$$

さらに，$$Z = \{z_i\}_{i=1}^m, z_i = I(x_i = y_i)$$と置きます．
そうすると，RIの式が，

$$
\begin{align*}
RI(y, \hat{y}) = \frac{1}{m} \sum_{i=1}^m z_i
\end{align*}
$$

と超絶シンプルになりました．
さて，上で定義したペナルティは「$$x \perp y$$の時のRIの分子のおおよその値」でした．
ここで，

$$
\begin{align*}
z' = \sum_{i=1}^m z_i
\end{align*}
$$

と定義すると，求めたいペナルティはまさに，「$$x \perp y$$の時の$$z'$$の期待値」に相当するのではないでしょうか？
というわけでここから，「$$x \perp y$$の時の$$z'$$の期待値」を求めていきます．

まず，$$x \perp y$$より，

$$
\begin{align*}
p(z=1) &= p(x=1, y=1) + p(x=0, y=0) = p(x=1)p(y=1) + p(x=0)p(y=0)
\end{align*}
$$

となります．よって，$$z'$$の期待値は，

$$
\begin{align*}
\mathbb{E}\left[z'\right] &= \mathbb{E}\left[\sum_{i=1}^m z_i\right] \\
&= \sum_{i=1}^m \mathbb{E}\left[z_i\right] \\
&= \sum_{i=1}^m 0 \cdot p(z=0) + 1 \cdot p(z=1) \\
&= m p(z=1) \\
&= m \left(p(x=1)p(y=1) + p(x=0)p(y=0) \right)\\
\end{align*}
$$

と書けます．すっきりしましたね．
$$p(x=0), p(x=1), p(y=0), p(y=1)$$は未知なので，標本から推定してやらねばなりません．
ここでは，以下のように，最尤推定で求めることにしましょう．

$$
\begin{align*}
p(x=1) &= \frac{1}{m} \sum_{i=1}^m x_i, \ p(x=0) = 1 - p(x=1) \\
p(y=1) &= \frac{1}{m} \sum_{i=1}^m y_i, \ p(y=0) = 1 - p(y=1)
\end{align*}
$$

あとは$$z'$$の期待値をRIの分母分子から引いてやるとARIに一致します．
Wikipediaの定義式なんかと一致するのを示したほうが良かったですね...．
時間があれば追記しておきます．
なお，具体例は以下のページが参考になります．

- <a href="http://y-uti.hatenablog.jp/entry/2014/01/19/133936" target="_blank">http://y-uti.hatenablog.jp/entry/2014/01/19/133936</a>
